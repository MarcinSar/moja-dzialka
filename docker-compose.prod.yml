version: '3.8'

# Production overrides for moja-dzialka
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  postgres:
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 4G
    environment:
      # PostgreSQL tuning for 155k parcels + spatial queries
      POSTGRES_SHARED_BUFFERS: 2GB
      POSTGRES_WORK_MEM: 256MB
      POSTGRES_MAINTENANCE_WORK_MEM: 512MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 4GB
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  neo4j:
    deploy:
      resources:
        limits:
          memory: 10G
        reservations:
          memory: 6G
    environment:
      NEO4J_dbms_memory_heap_initial__size: 4G
      NEO4J_dbms_memory_heap_max__size: 6G
      NEO4J_dbms_memory_pagecache_size: 2G
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  milvus:
    deploy:
      resources:
        limits:
          memory: 5G
        reservations:
          memory: 3G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  etcd:
    deploy:
      resources:
        limits:
          memory: 512M
    restart: always

  minio:
    deploy:
      resources:
        limits:
          memory: 512M
    restart: always

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    environment:
      DEBUG: "false"
      PERSISTENCE_BACKEND: redis_postgres
      LOG_LEVEL: INFO
    # Production: use gunicorn with uvicorn workers
    command: gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 --access-logfile - --error-logfile -
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  celery-worker:
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      NODE_ENV: production
    restart: always

  redis:
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    command: redis-server --maxmemory 1gb --maxmemory-policy allkeys-lru --appendonly yes
    restart: always

  mongo:
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
